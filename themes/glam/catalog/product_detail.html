{% extends "base.html" %}

{% block title %}{{ product.title }} - Exquisite Jewelry - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-rose-25 via-white to-champagne-25">
    <!-- Elegant Breadcrumb -->
    <div class="bg-white/80 backdrop-blur-lg border-b border-rose-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="{% url 'core:home' %}" class="text-gray-500 hover:text-primary-600 transition-colors duration-300 font-elegant flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                            </svg>
                            Home
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-rose-300 mx-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <a href="{% url 'catalog:product_list' %}" class="text-gray-500 hover:text-primary-600 transition-colors duration-300 font-elegant">Collections</a>
                        </div>
                    </li>
                    {% if product.category %}
                    <li>
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-rose-300 mx-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <a href="{% url 'catalog:product_list' %}?category={{ product.category.slug }}" class="text-gray-500 hover:text-primary-600 transition-colors duration-300 font-elegant">{{ product.category.name }}</a>
                        </div>
                    </li>
                    {% endif %}
                    <li>
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-rose-300 mx-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-gray-900 font-serif font-medium">{{ product.title|truncatechars:50 }}</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="lg:grid lg:grid-cols-2 lg:gap-16">
            <!-- Elegant Product Images Gallery -->
            <div class="mb-12 lg:mb-0">
                <!-- Main Product Image -->
                <div class="bg-white/80 backdrop-blur-lg rounded-3xl shadow-2xl overflow-hidden ring-1 ring-rose-100 group relative mb-6">
                    {% if product.image %}
                        <img id="main-product-image" src="{{ product.image.url }}" alt="{{ product.title }}" class="w-full h-96 lg:h-[700px] object-cover group-hover:scale-105 transition-all duration-700 cursor-zoom-in">
                    {% else %}
                        <div id="main-product-image" class="w-full h-96 lg:h-[700px] bg-gradient-to-br from-primary-100 via-white to-gold-100 flex items-center justify-center relative overflow-hidden">
                            <svg class="w-40 h-40 text-primary-600 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M5 16L3 14l5.5-11h7L21 14l-2 2H5zm2.7-5h8.6l-1.5-3H8.2l-1.5 3zm1.8 3l2.5 2.5L14.5 14H7.5z"/>
                            </svg>
                            <div class="absolute inset-0 bg-gradient-to-br from-primary-600/10 to-gold-600/10"></div>
                        </div>
                    {% endif %}

                    <!-- Wishlist overlay button -->
                    <div class="absolute top-6 right-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <button onclick="addToWishlist({{ product.id }})" class="bg-white/90 backdrop-blur-sm text-gray-700 p-4 rounded-full hover:bg-white hover:text-rose-600 transition-all duration-300 shadow-xl hover:shadow-2xl transform hover:scale-110">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Elegant Image Thumbnails Gallery -->
                <div class="flex flex-wrap gap-3 mt-6">
                    <p class="w-full text-sm text-gray-600 mb-2">Images: Main + {{ product.additional_images.count }} gallery</p>

                    {% if product.image %}
                    <button class="thumbnail-btn w-20 h-20 lg:w-24 lg:h-24 bg-white/80 backdrop-blur-lg rounded-2xl overflow-hidden ring-4 ring-primary-500 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl"
                            onclick="changeMainImage('{{ product.image.url }}', '{{ product.title }} - Main Image', this)"
                            data-image-url="{{ product.image.url }}">
                        <img src="{{ product.image.url }}" alt="{{ product.title }} - Main Image" class="w-full h-full object-cover">
                    </button>
                    {% endif %}

                    {% for gallery_image in product.additional_images.all %}
                    <button class="thumbnail-btn w-20 h-20 lg:w-24 lg:h-24 bg-white/80 backdrop-blur-lg rounded-2xl overflow-hidden ring-2 ring-rose-200 hover:ring-primary-400 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl"
                            onclick="changeMainImage('{{ gallery_image.image.url }}', '{{ gallery_image.alt_text }}', this)"
                            data-image-url="{{ gallery_image.image.url }}">
                        <img src="{{ gallery_image.image.url }}" alt="{{ gallery_image.alt_text }}" class="w-full h-full object-cover">
                    </button>
                    {% empty %}
                    <p class="w-full text-red-600 bg-red-100 p-2 rounded">No additional images found</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Luxury Product Information -->
            <div>
                <div class="bg-white/80 backdrop-blur-lg rounded-3xl shadow-2xl p-10 ring-1 ring-rose-100">
                    <!-- Product Title and Category -->
                    <div class="mb-8">
                        {% if product.category %}
                            <span class="text-primary-600 font-serif font-medium text-lg tracking-wider uppercase">{{ product.category.name }}</span>
                        {% endif %}
                        <h1 class="text-4xl lg:text-5xl font-serif font-bold text-gray-900 mt-3 leading-tight">{{ product.title }}</h1>
                        {% if product.sku %}
                            <p class="text-gray-500 font-elegant mt-3">Product Code: {{ product.sku }}</p>
                        {% endif %}
                    </div>

                    <!-- Elegant Rating and Reviews -->
                    {% if review_count > 0 %}
                    <div class="flex items-center mb-8 pb-6 border-b border-rose-100">
                        <div class="flex text-gold-400">
                            {% for i in "12345" %}
                                {% if forloop.counter <= average_rating %}
                                    <svg class="w-6 h-6 fill-current" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                {% else %}
                                    <svg class="w-6 h-6 text-gray-300 fill-current" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="ml-4 text-gray-600 font-elegant text-lg">{{ average_rating|floatformat:1 }} out of 5 ({{ review_count }} review{{ review_count|pluralize }})</span>
                    </div>
                    {% endif %}

                    <!-- Luxurious Price Display -->
                    <div class="mb-10">
                        {% if product.sale_price and product.sale_price < product.price %}
                            <div class="flex items-center space-x-4 mb-3">
                                <span class="text-5xl font-serif font-bold bg-gradient-to-r from-primary-600 to-rose-600 bg-clip-text text-transparent">${{ product.sale_price }}</span>
                                <span class="text-3xl text-gray-500 line-through font-elegant">${{ product.price }}</span>
                            </div>
                            <div class="inline-flex items-center bg-gradient-to-r from-red-100 to-red-200 text-red-800 px-4 py-2 rounded-full font-serif font-medium">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Save ${{ product.price|floatformat:2|add:"-"|add:product.sale_price|floatformat:2 }}
                            </div>
                        {% else %}
                            <span class="text-5xl font-serif font-bold bg-gradient-to-r from-primary-600 to-rose-600 bg-clip-text text-transparent">${{ product.price }}</span>
                        {% endif %}
                    </div>

                    <!-- Elegant Description -->
                    <div class="mb-10">
                        <h3 class="text-2xl font-serif font-semibold text-gray-900 mb-6">Description</h3>
                        {% if product.short_description %}
                            <p class="text-gray-700 font-elegant text-lg leading-relaxed mb-6">{{ product.short_description }}</p>
                        {% endif %}
                        {% if product.description %}
                            <div class="prose prose-gray max-w-none font-elegant">{{ product.description|linebreaks }}</div>
                        {% endif %}
                    </div>

                    <!-- Product Variations -->
                    {% if variants %}
                    <div class="mb-10">
                        <h3 class="text-2xl font-serif font-semibold text-gray-900 mb-4">Available Variations</h3>
                        <p class="text-sm text-purple-600 mb-6 font-medium">ðŸ’¡ Set quantities for the variations you want to add to cart</p>
                        <div class="space-y-6">
                            {% regroup variants by name as variant_groups %}
                            {% for group in variant_groups %}
                            <div class="variation-group">
                                <label class="block text-lg font-serif font-medium text-gray-800 mb-4">{{ group.grouper }}</label>
                                <div class="space-y-3">
                                    {% for variant in group.list %}
                                    <div class="flex items-center justify-between bg-white/80 backdrop-blur-sm border-2 border-rose-200 rounded-2xl p-4 {% if variant.stock_quantity <= 0 %}opacity-50{% endif %}">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-3">
                                                <span class="font-elegant font-semibold text-gray-800">{{ variant.value }}</span>
                                                {% if variant.price_adjustment != 0 %}
                                                    <span class="text-sm {% if variant.price_adjustment > 0 %}text-red-600{% else %}text-green-600{% endif %} font-medium">
                                                        ({% if variant.price_adjustment > 0 %}+{% endif %}â‚¹{{ variant.price_adjustment }})
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="mt-1">
                                                {% if variant.stock_quantity <= 0 %}
                                                    <span class="text-xs text-red-500 font-medium">Out of Stock</span>
                                                {% elif variant.stock_quantity <= 10 %}
                                                    <span class="text-xs text-amber-600 font-medium">Only {{ variant.stock_quantity }} left</span>
                                                {% else %}
                                                    <span class="text-xs text-emerald-600 font-medium">{{ variant.stock_quantity }} available</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="flex items-center space-x-3">
                                            {% if variant.stock_quantity > 0 %}
                                                <div class="flex items-center bg-rose-50 border border-rose-200 rounded-xl overflow-hidden">
                                                    <button type="button"
                                                            class="px-3 py-2 text-gray-600 hover:text-primary-600 hover:bg-rose-100 transition-all duration-300 font-serif font-medium"
                                                            onclick="decreaseVariantQty('{{ variant.id }}')">âˆ’</button>
                                                    <input type="number"
                                                           id="variant_qty_{{ variant.id }}"
                                                           name="variant_qty_{{ variant.id }}"
                                                           value="0"
                                                           min="0"
                                                           max="{{ variant.stock_quantity }}"
                                                           class="w-16 text-center border-0 focus:ring-0 outline-none text-sm font-serif font-medium py-2 bg-transparent"
                                                           onchange="updateVariantQty('{{ variant.id }}', this.value)">
                                                    <button type="button"
                                                            class="px-3 py-2 text-gray-600 hover:text-primary-600 hover:bg-rose-100 transition-all duration-300 font-serif font-medium"
                                                            onclick="increaseVariantQty('{{ variant.id }}', {{ variant.stock_quantity }})">+</button>
                                                </div>
                                            {% else %}
                                                <span class="text-gray-400 font-medium">Unavailable</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Add Selected Variants Button -->
                        <div class="mt-6">
                            <button onclick="addSelectedVariantsToCart()" class="w-full bg-gradient-to-r from-purple-500 via-purple-600 to-indigo-600 text-white py-4 px-8 rounded-2xl font-serif font-semibold text-lg hover:from-purple-600 hover:via-purple-700 hover:to-indigo-700 transition-all duration-500 transform hover:scale-105 shadow-xl hover:shadow-2xl">
                                Add Selected Variants to Cart
                            </button>
                        </div>

                        <!-- Selected Variation Display -->
                        <div id="selected-variations" class="mt-6 p-4 bg-gradient-to-r from-rose-50 to-pink-50 rounded-2xl border border-rose-100" style="display: none;">
                            <h4 class="font-serif font-semibold text-gray-900 mb-2">Selected:</h4>
                            <div id="variation-summary" class="text-gray-700 font-elegant"></div>
                            <div id="adjusted-price" class="mt-2 text-lg font-serif font-bold text-primary-600"></div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Luxury Stock Status -->
                    <!-- Debug: Product stock: {{ product.is_in_stock }}, Has variants: {{ variants|length }} -->
                    <div class="mb-10">
                        {% if product.is_in_stock or variants %}
                            <div class="flex items-center text-emerald-600 bg-emerald-50 px-6 py-4 rounded-2xl">
                                <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-serif font-medium text-lg">Available for Immediate Delivery</span>
                                {% if product.manage_stock and product.stock_quantity <= 10 %}
                                    <span class="ml-4 text-amber-600 bg-amber-100 px-3 py-1 rounded-full text-sm font-medium">Only {{ product.stock_quantity }} left!</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="flex items-center text-red-600 bg-red-50 px-6 py-4 rounded-2xl">
                                <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-serif font-medium text-lg">Currently Unavailable</span>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Elegant Add to Cart Form (only for products without variants) -->
                    {% if product.is_in_stock and not variants %}
                    <form method="post" action="{% url 'catalog:cart_add' product.id %}" class="mb-10" id="add-to-cart-form">
                        {% csrf_token %}
                        <input type="hidden" name="variant_id" id="selected-variant-id" value="">
                        <div class="flex items-center space-x-6">
                            <!-- Elegant Quantity Selector -->
                            <div class="flex items-center bg-white border-2 border-rose-200 rounded-2xl overflow-hidden">
                                <button type="button" id="decrease-qty" class="px-6 py-4 text-gray-600 hover:text-primary-600 hover:bg-rose-50 transition-all duration-300 font-serif font-medium text-lg">âˆ’</button>
                                <input type="number" name="quantity" id="quantity" value="1" min="1"
                                       {% if product.manage_stock %}max="{{ product.stock_quantity }}"{% endif %}
                                       class="w-20 text-center border-0 focus:ring-0 outline-none text-lg font-serif font-medium py-4">
                                <button type="button" id="increase-qty" class="px-6 py-4 text-gray-600 hover:text-primary-600 hover:bg-rose-50 transition-all duration-300 font-serif font-medium text-lg">+</button>
                            </div>

                            <!-- Luxury Add to Cart Button -->
                            <button type="submit" class="flex-1 bg-gradient-to-r from-primary-500 via-primary-600 to-rose-600 text-white py-5 px-10 rounded-2xl font-serif font-semibold text-lg hover:from-primary-600 hover:via-primary-700 hover:to-rose-700 transition-all duration-500 transform hover:scale-105 shadow-xl hover:shadow-2xl relative overflow-hidden group">
                                <span class="relative z-10">Add to Collection</span>
                                <div class="absolute inset-0 bg-gradient-to-r from-gold-400 to-gold-600 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                            </button>
                        </div>
                    </form>

                    <!-- Add to Wishlist Button -->
                    {% if user.is_authenticated %}
                    <div class="flex justify-center mb-6">
                        <button onclick="addToWishlist({{ product.id }})" class="flex items-center bg-white border-2 border-primary-300 text-primary-600 px-8 py-3 rounded-2xl font-serif font-semibold hover:bg-primary-50 hover:border-primary-400 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                            Add to Wishlist
                        </button>
                    </div>
                    {% endif %}

                    {% elif not product.is_in_stock and not variants %}
                    <div class="mb-10">
                        <button disabled class="w-full bg-gray-300 text-gray-500 py-5 px-10 rounded-2xl font-serif font-semibold text-lg cursor-not-allowed shadow-lg">
                            Currently Unavailable
                        </button>

                        <!-- Add to Wishlist Button (even for out of stock items) -->
                        {% if user.is_authenticated %}
                        <div class="flex justify-center mt-4">
                            <button onclick="addToWishlist({{ product.id }})" class="flex items-center bg-white border-2 border-primary-300 text-primary-600 px-8 py-3 rounded-2xl font-serif font-semibold hover:bg-primary-50 hover:border-primary-400 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                                Add to Wishlist
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Luxury Product Features -->
                    <div class="border-t border-rose-100 pt-8">
                        <h4 class="text-xl font-serif font-semibold text-gray-900 mb-6">Glam Promise</h4>
                        <div class="grid grid-cols-2 gap-6 text-sm">
                            <div class="flex items-center text-gray-600 bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-2xl">
                                <svg class="w-6 h-6 mr-3 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-elegant">Complimentary Delivery</span>
                            </div>
                            <div class="flex items-center text-gray-600 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-2xl">
                                <svg class="w-6 h-6 mr-3 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-elegant">Authenticity Certified</span>
                            </div>
                            <div class="flex items-center text-gray-600 bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-2xl">
                                <svg class="w-6 h-6 mr-3 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="font-elegant">Lifetime Care Service</span>
                            </div>
                            <div class="flex items-center text-gray-600 bg-gradient-to-r from-amber-50 to-yellow-50 p-4 rounded-2xl">
                                <svg class="w-6 h-6 mr-3 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-elegant">Secure Transactions</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Elegant Reviews Section -->
        {% if site_settings.enable_reviews %}
        <div class="mt-20">
            <div class="bg-white/80 backdrop-blur-lg rounded-3xl shadow-2xl p-10 ring-1 ring-rose-100">
                <h2 class="text-3xl font-serif font-bold text-gray-900 mb-10 text-center">Customer Reviews</h2>

                <!-- Elegant Add Review Form -->
                {% if user.is_authenticated and not user_has_reviewed %}
                <div class="bg-gradient-to-br from-rose-50 to-pink-50 rounded-3xl p-8 mb-12 border border-rose-100">
                    <h3 class="text-xl font-serif font-semibold text-gray-900 mb-6">Share Your Experience</h3>
                    <form method="post" action="{% url 'catalog:add_review' product.id %}">
                        {% csrf_token %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-serif font-medium text-gray-700 mb-3">Your Rating</label>
                                <select name="rating" required class="w-full px-4 py-3 border border-rose-200 rounded-2xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none bg-white/80 backdrop-blur-sm font-elegant">
                                    <option value="">Select your rating</option>
                                    <option value="5">â˜…â˜…â˜…â˜…â˜… Exceptional</option>
                                    <option value="4">â˜…â˜…â˜…â˜…â˜† Excellent</option>
                                    <option value="3">â˜…â˜…â˜…â˜†â˜† Very Good</option>
                                    <option value="2">â˜…â˜…â˜†â˜†â˜† Good</option>
                                    <option value="1">â˜…â˜†â˜†â˜†â˜† Fair</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-serif font-medium text-gray-700 mb-3">Review Title</label>
                                <input type="text" name="title" required class="w-full px-4 py-3 border border-rose-200 rounded-2xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none bg-white/80 backdrop-blur-sm font-elegant" placeholder="Summarize your experience">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-serif font-medium text-gray-700 mb-3">Your Review</label>
                            <textarea name="comment" rows="5" required class="w-full px-4 py-3 border border-rose-200 rounded-2xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none bg-white/80 backdrop-blur-sm font-elegant" placeholder="Share your thoughts about this beautiful piece"></textarea>
                        </div>
                        <button type="submit" class="bg-gradient-to-r from-primary-500 via-primary-600 to-rose-600 text-white px-8 py-4 rounded-2xl font-serif font-semibold hover:from-primary-600 hover:via-primary-700 hover:to-rose-700 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                            Submit Review
                        </button>
                    </form>
                </div>
                {% elif not user.is_authenticated %}
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-3xl p-8 mb-12">
                    <p class="text-blue-800 font-elegant text-lg text-center">
                        <a href="{% url 'users:login' %}" class="font-serif font-semibold hover:underline text-primary-600">Sign in</a> to share your experience with this exquisite piece.
                    </p>
                </div>
                {% endif %}

                <!-- Elegant Reviews List -->
                {% if reviews %}
                <div class="space-y-8">
                    {% for review in reviews %}
                    <div class="bg-gradient-to-br from-white to-rose-50 border border-rose-100 rounded-3xl p-8 shadow-lg hover:shadow-xl transition-all duration-300">
                        <div class="flex items-start justify-between mb-6">
                            <div>
                                <div class="flex items-center mb-3">
                                    <div class="flex text-gold-400">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= review.rating %}
                                                <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                                </svg>
                                            {% else %}
                                                <svg class="w-5 h-5 text-gray-300 fill-current" viewBox="0 0 20 20">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                                </svg>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <span class="ml-3 font-serif font-semibold text-gray-900 text-lg">{{ review.title }}</span>
                                </div>
                                <p class="text-gray-600 font-elegant">By {{ review.user.get_full_name|default:review.user.username }} â€¢ {{ review.created_at|date:"F j, Y" }}</p>
                            </div>
                        </div>
                        <p class="text-gray-700 font-elegant text-lg leading-relaxed">{{ review.comment }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-16">
                    <svg class="w-20 h-20 text-rose-300 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <p class="text-gray-500 font-elegant text-lg">Be the first to share your experience with this beautiful piece!</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Elegant Related Products -->
        {% if related_products %}
        <div class="mt-20">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-serif font-bold text-gray-900 mb-4">You May Also Adore</h2>
                <p class="text-gray-600 font-elegant text-xl">Curated pieces that complement your exquisite taste</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10">
                {% for related_product in related_products|slice:":4" %}
                <div class="group bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl hover:shadow-3xl transition-all duration-500 overflow-hidden transform hover:scale-105 ring-1 ring-rose-100 hover:ring-primary-200">
                    <div class="aspect-w-1 aspect-h-1 bg-gradient-to-br from-rose-50 to-champagne-50 rounded-t-3xl overflow-hidden relative">
                        {% if related_product.image %}
                            <img src="{{ related_product.image.url }}" alt="{{ related_product.title }}" class="w-full h-64 object-cover group-hover:scale-110 transition-transform duration-700">
                        {% else %}
                            <div class="w-full h-64 bg-gradient-to-br from-primary-100 via-white to-gold-100 flex items-center justify-center group-hover:scale-110 transition-transform duration-700">
                                <svg class="w-16 h-16 text-primary-600 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M5 16L3 14l5.5-11h7L21 14l-2 2H5zm2.7-5h8.6l-1.5-3H8.2l-1.5 3zm1.8 3l2.5 2.5L14.5 14H7.5z"/>
                                </svg>
                            </div>
                        {% endif %}
                        <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <button class="bg-white/90 backdrop-blur-sm text-gray-700 p-3 rounded-full hover:bg-white hover:text-rose-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-110">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <h3 class="text-lg font-serif font-semibold text-gray-900 mb-3 group-hover:text-primary-600 transition-colors duration-300 line-clamp-2">
                            <a href="{% url 'catalog:product_detail' related_product.slug %}">{{ related_product.title|truncatechars:45 }}</a>
                        </h3>
                        <div class="flex items-center justify-between">
                            {% if related_product.sale_price and related_product.sale_price < related_product.price %}
                                <div class="flex items-center space-x-2">
                                    <span class="text-xl font-serif font-bold text-primary-600">${{ related_product.sale_price }}</span>
                                    <span class="text-sm text-gray-500 line-through font-elegant">${{ related_product.price }}</span>
                                </div>
                            {% else %}
                                <span class="text-xl font-serif font-bold text-primary-600">${{ related_product.price }}</span>
                            {% endif %}
                            <a href="{% url 'catalog:product_detail' related_product.slug %}" class="bg-gradient-to-r from-primary-500 to-rose-600 text-white px-4 py-2 rounded-full text-sm font-serif font-medium hover:from-primary-600 hover:to-rose-700 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                                View
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Variant quantity control functions
function decreaseVariantQty(variantId) {
    console.log('Decrease button clicked for variant:', variantId);
    const input = document.getElementById('variant_qty_' + variantId);
    console.log('Found input:', input);
    if (!input) {
        console.error('Input not found for variant:', variantId);
        return;
    }
    const currentValue = parseInt(input.value) || 0;
    console.log('Current value:', currentValue);
    if (currentValue > 0) {
        input.value = currentValue - 1;
        console.log('New value:', input.value);
    }
}

function increaseVariantQty(variantId, maxStock) {
    console.log('Increase button clicked for variant:', variantId, 'max stock:', maxStock);
    const input = document.getElementById('variant_qty_' + variantId);
    console.log('Found input:', input);
    if (!input) {
        console.error('Input not found for variant:', variantId);
        return;
    }
    const currentValue = parseInt(input.value) || 0;
    console.log('Current value:', currentValue, 'Max value:', maxStock);
    if (currentValue < maxStock) {
        input.value = currentValue + 1;
        console.log('New value:', input.value);
    }
}

function addSelectedVariantsToCart() {
    console.log('Add selected variants to cart clicked');

    // Collect all variant quantities > 0
    const selectedVariants = [];
    const variantInputs = document.querySelectorAll('input[name^="variant_qty_"]');
    console.log('Found variant inputs:', variantInputs.length);

    variantInputs.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        if (quantity > 0) {
            const variantId = input.name.replace('variant_qty_', '');
            selectedVariants.push({
                variantId: variantId,
                quantity: quantity
            });
        }
    });

    console.log('Selected variants:', selectedVariants);

    if (selectedVariants.length === 0) {
        alert('Please select at least one variation with quantity > 0');
        return;
    }

    // Add each variant to cart sequentially
    addVariantsSequentially(selectedVariants, 0, variantInputs);
}

function addVariantsSequentially(variants, index, variantInputs) {
    if (index >= variants.length) {
        // All variants added successfully
        variantInputs.forEach(input => {
            input.value = '0';
        });
        alert('All selected variations added to cart successfully!');
        return;
    }

    const variant = variants[index];
    console.log(`Adding variant ${index + 1}/${variants.length}: ${variant.variantId} (qty: ${variant.quantity})`);

    addVariantToCart(variant.variantId, variant.quantity, () => {
        // Successfully added this variant, move to next one
        addVariantsSequentially(variants, index + 1, variantInputs);
    });
}

function addVariantToCart(variantId, quantity, callback) {
    fetch("{% url 'catalog:cart_add' product.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `variant_id=${variantId}&quantity=${quantity}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Successfully added variant', variantId, 'to cart');
            if (callback) callback();
        } else {
            alert(data.message || 'Failed to add variant to cart');
            console.error('Failed to add variant:', variantId, data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding to cart');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Enhanced quantity controls with elegant animations
document.addEventListener('DOMContentLoaded', function() {
    const qtyInput = document.getElementById('quantity');
    const decreaseBtn = document.getElementById('decrease-qty');
    const increaseBtn = document.getElementById('increase-qty');

    if (decreaseBtn && increaseBtn && qtyInput) {
        decreaseBtn.addEventListener('click', function() {
            let currentQty = parseInt(qtyInput.value);
            if (currentQty > 1) {
                qtyInput.value = currentQty - 1;
                // Add subtle animation
                qtyInput.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    qtyInput.style.transform = 'scale(1)';
                }, 150);
            }
        });

        increaseBtn.addEventListener('click', function() {
            let currentQty = parseInt(qtyInput.value);
            let maxQty = parseInt(qtyInput.getAttribute('max')) || 999;
            if (currentQty < maxQty) {
                qtyInput.value = currentQty + 1;
                // Add subtle animation
                qtyInput.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    qtyInput.style.transform = 'scale(1)';
                }, 150);
            }
        });
    }

    // Image Gallery Functionality
    let currentImageIndex = 0;
    const allImages = [];

    // Collect all image URLs for navigation
    {% if product.image %}
    allImages.push({
        url: '{{ product.image.url }}',
        alt: '{{ product.title|escapejs }} - Main Image'
    });
    {% endif %}

    {% for gallery_image in product.additional_images.all %}
    allImages.push({
        url: '{{ gallery_image.image.url }}',
        alt: '{{ gallery_image.alt_text|escapejs }}'
    });
    {% endfor %}

    // Change main image function
    window.changeMainImage = function(imageUrl, altText, thumbnailElement) {
        const mainImage = document.getElementById('main-product-image');
        if (mainImage) {
            // Add loading effect
            mainImage.style.opacity = '0.7';

            setTimeout(() => {
                if (mainImage.tagName === 'IMG') {
                    mainImage.src = imageUrl;
                    mainImage.alt = altText;
                } else {
                    // Replace div with img if it was placeholder
                    const newImg = document.createElement('img');
                    newImg.id = 'main-product-image';
                    newImg.src = imageUrl;
                    newImg.alt = altText;
                    newImg.className = 'w-full h-96 lg:h-[700px] object-cover group-hover:scale-105 transition-all duration-700 cursor-zoom-in';
                    mainImage.parentNode.replaceChild(newImg, mainImage);
                }

                // Remove loading effect
                setTimeout(() => {
                    const img = document.getElementById('main-product-image');
                    if (img) img.style.opacity = '1';
                }, 100);
            }, 200);
        }

        // Update thumbnail active state
        document.querySelectorAll('.thumbnail-btn').forEach(btn => {
            btn.classList.remove('ring-primary-500', 'ring-4');
            btn.classList.add('ring-rose-200', 'ring-2');
        });

        if (thumbnailElement) {
            thumbnailElement.classList.remove('ring-rose-200', 'ring-2');
            thumbnailElement.classList.add('ring-primary-500', 'ring-4');
        }

        // Update current index
        currentImageIndex = allImages.findIndex(img => img.url === imageUrl);
    }

    // Navigation arrows functionality
    const prevBtn = document.getElementById('prev-image');
    const nextBtn = document.getElementById('next-image');

    if (prevBtn && nextBtn && allImages.length > 1) {
        prevBtn.addEventListener('click', function() {
            currentImageIndex = currentImageIndex > 0 ? currentImageIndex - 1 : allImages.length - 1;
            const targetImage = allImages[currentImageIndex];
            const targetThumbnail = document.querySelector(`[data-image-url="${targetImage.url}"]`);
            changeMainImage(targetImage.url, targetImage.alt, targetThumbnail);
        });

        nextBtn.addEventListener('click', function() {
            currentImageIndex = currentImageIndex < allImages.length - 1 ? currentImageIndex + 1 : 0;
            const targetImage = allImages[currentImageIndex];
            const targetThumbnail = document.querySelector(`[data-image-url="${targetImage.url}"]`);
            changeMainImage(targetImage.url, targetImage.alt, targetThumbnail);
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                prevBtn.click();
            } else if (e.key === 'ArrowRight') {
                nextBtn.click();
            }
        });
    }

    // Add elegant hover effects
    const productImage = document.querySelector('#main-product-image');
    if (productImage) {
        let isHovered = false;
        productImage.addEventListener('mouseenter', function() {
            if (!isHovered) {
                isHovered = true;
                this.style.filter = 'brightness(1.05) contrast(1.05)';
            }
        });
        productImage.addEventListener('mouseleave', function() {
            isHovered = false;
            this.style.filter = 'brightness(1) contrast(1)';
        });

        // Add click to zoom functionality
        productImage.addEventListener('click', function() {
            if (this.tagName === 'IMG') {
                openImageModal(this.src, this.alt);
            }
        });
    }

    // Image Modal for full-size view
    function openImageModal(imageSrc, imageAlt) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 backdrop-blur-sm';
        modal.onclick = function() { modal.remove(); };

        modal.innerHTML = `
            <div class="relative max-w-5xl max-h-full p-4">
                <img src="${imageSrc}" alt="${imageAlt}" class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl">
                <button onclick="this.closest('.fixed').remove()" class="absolute top-6 right-6 bg-white/20 backdrop-blur-sm text-white p-3 rounded-full hover:bg-white/30 transition-all duration-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        `;

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        // Remove modal on escape key
        const handleEscape = function(e) {
            if (e.key === 'Escape') {
                modal.remove();
                document.body.style.overflow = 'auto';
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);

        // Restore scrolling when modal is removed
        modal.addEventListener('DOMNodeRemoved', function() {
            document.body.style.overflow = 'auto';
        });
    }

    // Add to Wishlist functionality
    window.addToWishlist = async function(productId) {
        try {
            const response = await fetch('{% url "wishlist:add_to_wishlist" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    product_id: productId
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update wishlist count in navigation
                const countElement = document.getElementById('wishlist-count');
                if (countElement) {
                    countElement.textContent = data.wishlist_count;
                }

                // Show success message
                showMessage(data.message, 'success');

                // Optional: Change button to "Added" state
                const button = event.target.closest('button');
                if (button) {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>Added to Wishlist!';
                    button.disabled = true;
                    button.classList.add('bg-green-50', 'border-green-300', 'text-green-600');
                    button.classList.remove('text-primary-600', 'border-primary-300', 'hover:bg-primary-50');

                    // Reset after 3 seconds
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        button.classList.remove('bg-green-50', 'border-green-300', 'text-green-600');
                        button.classList.add('text-primary-600', 'border-primary-300', 'hover:bg-primary-50');
                    }, 3000);
                }
            } else {
                showMessage(data.message, 'error');
            }
        } catch (error) {
            showMessage('Error adding to wishlist', 'error');
        }
    }

    // CSRF token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Show message function
    function showMessage(message, type) {
        // Create a temporary message element
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-24 right-4 z-50 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        messageDiv.textContent = message;

        document.body.appendChild(messageDiv);

        // Remove after 3 seconds
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }

    // Product Variation Selection functionality
    let selectedVariants = {};
    const basePrice = {{ product.get_price }};

    window.selectVariant = function(button) {
        const variantName = button.dataset.variantName;
        const variantValue = button.dataset.variantValue;
        const variantId = button.dataset.variantId;
        const priceAdjustment = parseFloat(button.dataset.priceAdjustment) || 0;
        const stockQuantity = parseInt(button.dataset.stockQuantity) || 0;

        // Remove active state from siblings in the same group
        const variationGroup = button.closest('.variation-group');
        variationGroup.querySelectorAll('.variant-option').forEach(btn => {
            btn.classList.remove('border-primary-500', 'bg-primary-100', 'text-primary-800');
            btn.classList.add('border-rose-200', 'text-gray-700');
        });

        // Add active state to selected button
        button.classList.remove('border-rose-200', 'text-gray-700');
        button.classList.add('border-primary-500', 'bg-primary-100', 'text-primary-800');

        // Update selected variants
        selectedVariants[variantName] = {
            value: variantValue,
            id: variantId,
            priceAdjustment: priceAdjustment,
            stockQuantity: stockQuantity
        };

        // Update the hidden form field with the selected variant ID
        // For now, we'll use the first selected variant ID
        // In the future, this could be enhanced to handle multiple variant combinations
        const selectedVariantId = Object.values(selectedVariants)[0]?.id || '';
        const hiddenField = document.getElementById('selected-variant-id');
        if (hiddenField) {
            hiddenField.value = selectedVariantId;
        }

        // Update quantity input max value based on variant stock
        const quantityInput = document.getElementById('quantity');
        if (quantityInput && stockQuantity > 0) {
            quantityInput.max = stockQuantity;
            // Reset quantity if current value exceeds stock
            if (parseInt(quantityInput.value) > stockQuantity) {
                quantityInput.value = Math.min(stockQuantity, 1);
            }
        }

        updateVariationDisplay();
    }

    function updateVariationDisplay() {
        const selectedDiv = document.getElementById('selected-variations');
        const summaryDiv = document.getElementById('variation-summary');
        const priceDiv = document.getElementById('adjusted-price');

        if (Object.keys(selectedVariants).length === 0) {
            selectedDiv.style.display = 'none';
            return;
        }

        // Show selected variations
        selectedDiv.style.display = 'block';

        // Build summary text
        const summaryText = Object.entries(selectedVariants)
            .map(([name, variant]) => `${name}: ${variant.value}`)
            .join(', ');
        summaryDiv.textContent = summaryText;

        // Calculate adjusted price
        const totalAdjustment = Object.values(selectedVariants)
            .reduce((sum, variant) => sum + variant.priceAdjustment, 0);
        const finalPrice = basePrice + totalAdjustment;

        priceDiv.innerHTML = `Final Price: <span class="text-2xl">$${finalPrice.toFixed(2)}</span>`;

        // Update the main price display if needed
        updateMainPriceDisplay(finalPrice, totalAdjustment);
    }

    function updateMainPriceDisplay(finalPrice, adjustment) {
        // Find the main price element and update it to show variation effect
        const mainPriceElements = document.querySelectorAll('.text-5xl');
        if (mainPriceElements.length > 0 && adjustment !== 0) {
            const mainPriceElement = mainPriceElements[0];
            mainPriceElement.innerHTML = `$${finalPrice.toFixed(2)} <span class="text-2xl text-gray-500">($${basePrice.toFixed(2)} ${adjustment > 0 ? '+' : ''}$${adjustment.toFixed(2)})</span>`;
        } else if (mainPriceElements.length > 0 && adjustment === 0) {
            const mainPriceElement = mainPriceElements[0];
            mainPriceElement.textContent = `$${basePrice.toFixed(2)}`;
        }
    }
});
</script>
{% endblock %}
{% extends 'store/base.html' %}
{% load custom_filters %}
{% block title %}Secure Checkout - {{ SITE_NAME }}{% endblock %}

{% block content %}
<!-- Premium Checkout Page -->
<div class="bg-gray-50 min-h-screen py-2 sm:py-4 md:py-8">
  <div class="max-w-7xl mx-auto px-2 sm:px-4 checkout-container">
    
    <!-- Header Section -->
    <div class="text-center mb-4 sm:mb-6 md:mb-12">
      <div class="inline-flex items-center px-2 sm:px-3 py-1 sm:py-2 rounded-full bg-gradient-to-r from-yellow-100 to-amber-100 text-yellow-800 text-xs font-medium mb-3 sm:mb-4 md:mb-6">
        <svg class="w-3 h-3 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
        </svg>
        Secure Checkout
      </div>
      <h1 class="text-xl sm:text-2xl md:text-3xl lg:text-5xl font-bold text-gray-900 mb-2 sm:mb-3 md:mb-4 px-2">
        Complete Your <span class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-600 to-amber-600">Order</span>
      </h1>
      <p class="text-sm sm:text-base md:text-lg lg:text-xl text-gray-600 max-w-2xl mx-auto leading-relaxed px-4">
        Secure payment processing with SSL encryption. Your information is protected.
      </p>
    </div>

    <!-- Progress Indicator -->
    <div class="mb-4 sm:mb-6 md:mb-12 px-4">
      <div class="flex items-center justify-center space-x-1 sm:space-x-2 md:space-x-4 max-w-xs sm:max-w-sm md:max-w-md mx-auto">
        <div class="flex items-center">
          <div class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-bold">✓</div>
          <span class="ml-1 text-xs font-medium text-green-600 hidden sm:inline">Cart</span>
        </div>
        <div class="flex-1 h-0.5 bg-green-300 min-w-0"></div>
        <div class="flex items-center">
          <div class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 bg-yellow-500 rounded-full flex items-center justify-center text-black text-xs font-bold">2</div>
          <span class="ml-1 text-xs font-medium text-yellow-600 hidden sm:inline">Checkout</span>
        </div>
        <div class="flex-1 h-0.5 bg-gray-300 min-w-0"></div>
        <div class="flex items-center">
          <div class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 text-xs font-bold">3</div>
          <span class="ml-1 text-xs font-medium text-gray-500 hidden sm:inline">Complete</span>
        </div>
      </div>
    </div>

    <!-- Messages -->
    {% if messages %}
      <div class="mb-8 max-w-md mx-auto">
        {% for message in messages %}
          <div class="p-4 rounded-xl {% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %} mb-3 animate-fade-in">
            <div class="flex items-center">
              {% if message.tags == 'success' %}
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
              {% elif message.tags == 'error' %}
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/>
                </svg>
              {% endif %}
              {{ message }}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Main Checkout Grid -->
    <div class="flex flex-col lg:grid lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-12">

      <!-- Order Summary - Mobile First -->
      <div class="w-full lg:col-span-1 lg:order-2">
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg sm:shadow-xl p-3 sm:p-4 md:p-8 lg:sticky lg:top-8">
          <div class="flex items-center mb-4 sm:mb-6 md:mb-8">
            <div class="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 bg-gradient-to-r from-purple-400 to-purple-500 rounded-full flex items-center justify-center mr-2 sm:mr-3 md:mr-4">
              <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
            </div>
            <div>
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900">Order Summary</h2>
              <p class="text-xs sm:text-sm md:text-base text-gray-600">{{ cart_items|length }} item{{ cart_items|length|pluralize }}</p>
            </div>
          </div>

          <!-- Order Items -->
          <div class="space-y-2 sm:space-y-3 md:space-y-4 mb-3 sm:mb-4 md:mb-6">
            {% for item in cart_items %}
              <div class="flex items-center space-x-2 sm:space-x-3 md:space-x-4 p-2 sm:p-3 md:p-4 bg-gray-50 rounded-lg sm:rounded-xl">
                <div class="relative flex-shrink-0">
                  <img src="{{ item.product.image.url }}" 
                       alt="{{ item.product.name }}" 
                       class="w-10 h-10 sm:w-12 sm:h-12 md:w-16 md:h-16 object-contain rounded-md sm:rounded-lg border border-gray-200">
                  <div class="absolute -top-1 -right-1 w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 bg-yellow-400 text-black text-xs font-bold rounded-full flex items-center justify-center">
                    {{ item.quantity }}
                  </div>
                </div>
                <div class="flex-1 min-w-0">
                  <h4 class="text-xs sm:text-sm md:text-base font-semibold text-gray-900 truncate">{{ item.product.name }}</h4>
                  <p class="text-xs text-gray-600">{{ item.product.category.name }}</p>
                  <p class="text-xs sm:text-xs md:text-sm font-medium text-gray-900">₹{{ item.product.price }} each</p>
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-xs sm:text-sm md:text-base font-bold text-gray-900">₹{{ item.quantity|multiply:item.product.price|floatformat:2 }}</p>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Pricing Breakdown -->
          <div class="border-t pt-4 md:pt-6 space-y-2 md:space-y-3">
            <div class="flex justify-between text-sm md:text-base text-gray-600">
              <span>Subtotal</span>
              <span>₹{{ cart.get_total|floatformat:2 }}</span>
            </div>
            <div class="flex justify-between text-sm md:text-base text-gray-600">
              <span>Shipping</span>
              <span class="text-green-600 font-medium">Free</span>
            </div>
            <div id="shipping-charges-info" class="flex justify-between text-xs text-gray-500 hidden">
              <span>Logistics Charges:</span>
              <span>₹100 (online) non-refundable</span>
            </div>
            <div class="flex justify-between text-sm md:text-base text-gray-600">
              <span>Tax</span>
              <span>Included</span>
            </div>
            <div class="border-t pt-2 md:pt-3">
              <div class="flex justify-between items-center font-bold text-lg md:text-xl text-gray-900">
                <span>Total</span>
                <span class="text-xl md:text-2xl text-yellow-600" id="total-amount">₹{{ cart.get_total|floatformat:2 }}</span>
              </div>
              <div id="cod-advance-info" class="mt-2 text-sm text-gray-600 hidden">
                <div class="flex justify-between">
                  <span>Advance Payment (Online):</span>
                  <span class="font-medium">₹100.00</span>
                </div>
                <div class="flex justify-between">
                  <span>Remaining COD Amount:</span>
                  <span class="font-medium" id="cod-remaining">₹{{ cart.get_total|add:"-100"|floatformat:2 }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Security Badges -->
          <div class="mt-6 md:mt-8 pt-4 md:pt-6 border-t">
            <div class="grid grid-cols-3 gap-2 md:gap-3 text-center">
              <div class="text-xs text-gray-600">
                <div class="w-6 h-6 md:w-8 md:h-8 mx-auto mb-1 bg-green-100 rounded-full flex items-center justify-center">
                  <svg class="w-3 h-3 md:w-4 md:h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                  </svg>
                </div>
                SSL Secured
              </div>
              <div class="text-xs text-gray-600">
                <div class="w-6 h-6 md:w-8 md:h-8 mx-auto mb-1 bg-blue-100 rounded-full flex items-center justify-center">
                  <svg class="w-3 h-3 md:w-4 md:h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                  </svg>
                </div>
                Safe Payment
              </div>
              <div class="text-xs text-gray-600">
                <div class="w-6 h-6 md:w-8 md:h-8 mx-auto mb-1 bg-yellow-100 rounded-full flex items-center justify-center">
                  <svg class="w-3 h-3 md:w-4 md:h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                  </svg>
                </div>
                Fast Delivery
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Left Side: Shipping & Payment Forms -->
      <div class="w-full lg:col-span-2 lg:order-1 space-y-4 sm:space-y-6 md:space-y-8">
        
        <!-- Shipping Information -->
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg sm:shadow-xl p-3 sm:p-4 md:p-8">
          <div class="flex items-center mb-4 sm:mb-6 md:mb-8">
            <div class="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 bg-gradient-to-r from-yellow-400 to-amber-500 rounded-full flex items-center justify-center mr-2 sm:mr-3 md:mr-4">
              <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
            <div>
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900">Shipping Information</h2>
              <p class="text-xs sm:text-sm md:text-base text-gray-600">Where should we deliver your premium accessories?</p>
            </div>
          </div>

          <form method="POST" class="space-y-4 md:space-y-6" id="checkout-form">
            {% csrf_token %}
            
            <!-- Enhanced Form Fields -->
            {% for field in form %}
              <div class="form-group">
                <label for="{{ field.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                  {{ field.label }}
                  {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                </label>
                <div class="relative">
                  {{ field }}
                  
                  <!-- Field Icons -->
                  {% if field.name == 'email' %}
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                      <svg class="h-4 w-4 md:h-5 md:w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"/>
                      </svg>
                    </div>
                  {% elif field.name == 'phone_number' %}
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                      <svg class="h-4 w-4 md:h-5 md:w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                      </svg>
                    </div>
                  {% elif 'address' in field.name %}
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                      <svg class="h-4 w-4 md:h-5 md:w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                      </svg>
                    </div>
                  {% endif %}
                </div>
                
                {% if field.errors %}
                  <p class="text-xs md:text-sm text-red-600 mt-2 flex items-center">
                    <svg class="w-3 h-3 md:w-4 md:h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                    </svg>
                    {{ field.errors.0 }}
                  </p>
                {% endif %}
                
                {% if field.help_text %}
                  <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
                {% endif %}
              </div>
            {% endfor %}

            <!-- Payment Section -->
            <div class="border-t pt-6 md:pt-8 mt-6 md:mt-8">
              <div class="flex items-center mb-4 md:mb-6">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-r from-green-400 to-green-500 rounded-full flex items-center justify-center mr-3 md:mr-4">
                  <svg class="w-4 h-4 md:w-5 md:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="text-lg md:text-xl font-bold text-gray-900">Payment Method</h3>
                  <p class="text-sm md:text-base text-gray-600">Choose your preferred payment option</p>
                </div>
              </div>

              <!-- Payment Options -->
              <div class="grid grid-cols-1 gap-3 md:gap-4 mb-4 md:mb-6">
                <label class="relative">
                  <input type="radio" name="payment_method" value="online" class="peer sr-only" checked>
                  <div class="p-3 md:p-4 border-2 border-gray-200 rounded-xl cursor-pointer peer-checked:border-yellow-400 peer-checked:bg-yellow-50 transition-all duration-300">
                    <div class="flex items-center">
                      <svg class="w-5 h-5 md:w-6 md:h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                      </svg>
                      <div>
                        <div class="text-sm md:text-base font-semibold text-gray-900">Online Payment</div>
                        <div class="text-xs md:text-sm text-gray-600">Card/UPI/Wallet</div>
                      </div>
                    </div>
                  </div>
                </label>

                <label class="relative">
                  <input type="radio" name="payment_method" value="cod" class="peer sr-only">
                  <div class="p-3 md:p-4 border-2 border-gray-200 rounded-xl cursor-pointer peer-checked:border-yellow-400 peer-checked:bg-yellow-50 transition-all duration-300">
                    <div class="flex items-center">
                      <svg class="w-5 h-5 md:w-6 md:h-6 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                      </svg>
                      <div>
                        <div class="text-sm md:text-base font-semibold text-gray-900">Cash on Delivery</div>
                        <div class="text-xs md:text-sm text-gray-600">₹100 logistics + remaining on delivery</div>
                      </div>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" 
                    class="w-full bg-gradient-to-r from-yellow-400 to-amber-500 text-black py-3 md:py-4 px-6 md:px-8 rounded-xl font-bold text-base md:text-lg hover:from-yellow-500 hover:to-amber-600 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
              <span class="flex items-center justify-center">
                <svg class="w-4 h-4 md:w-5 md:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
                Complete Secure Order
              </span>
            </button>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Enhanced Form Styling -->
<style>
.form-group input,
.form-group select,
.form-group textarea {
  @apply w-full px-3 py-2 sm:px-3 sm:py-2 md:px-4 md:py-3 border border-gray-300 rounded-lg sm:rounded-xl focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all duration-300 text-sm md:text-base;
  min-height: 40px;
  font-size: 16px; /* Prevents zoom on iOS */
}

@media (min-width: 640px) {
  .form-group input,
  .form-group select,
  .form-group textarea {
    font-size: 0.875rem;
  }
}

@media (min-width: 768px) {
  .form-group input,
  .form-group select,
  .form-group textarea {
    font-size: 1rem;
  }
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  @apply shadow-lg;
}

.form-group label {
  @apply block text-sm font-semibold text-gray-700 mb-2;
}

/* Mobile specific optimizations */
@media (max-width: 640px) {
  .checkout-container {
    padding-left: 8px;
    padding-right: 8px;
    max-width: 100vw;
    overflow-x: hidden;
  }
  
  .mobile-card {
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 16px;
  }
}

/* Prevent horizontal scroll */
body {
  overflow-x: hidden;
}

.form-group {
  max-width: 100%;
  overflow: hidden;
}

@keyframes fade-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fade-in 0.3s ease-out;
}
</style>

<!-- Meta Pixel Checkout Event Tracking -->
<script>
// Track checkout page view event
if (typeof fbq !== 'undefined') {
  fbq('track', 'InitiateCheckout', {
    content_name: 'Checkout Page',
    content_category: 'ecommerce',
    value: {{ cart.get_total|floatformat:2 }},
    currency: 'INR',
    num_items: {{ cart_items|length }}
  });
}

// Track Google Analytics checkout event
if (typeof gtag !== 'undefined') {
  gtag('event', 'begin_checkout', {
    currency: 'INR',
    value: {{ cart.get_total|floatformat:2 }},
    items: [
      {% for item in cart_items %}
      {
        item_id: '{{ item.product.id }}',
        item_name: '{{ item.product.name|addslashes }}',
        category: '{{ item.product.category.name|addslashes }}',
        quantity: {{ item.quantity }},
        price: {{ item.product.price }}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  });
}
</script>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Form validation enhancement
  const form = document.getElementById('checkout-form');
  const submitBtn = form.querySelector('button[type="submit"]');
  const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
  const totalAmount = document.getElementById('total-amount');
  const codAdvanceInfo = document.getElementById('cod-advance-info');
  const codRemaining = document.getElementById('cod-remaining');
  const shippingChargesInfo = document.getElementById('shipping-charges-info');
  
  const originalTotal = {{ cart.get_total|floatformat:2 }};
  
  // Payment method change handler
  paymentMethods.forEach(method => {
    method.addEventListener('change', function() {
      // Track payment method selection
      if (typeof fbq !== 'undefined') {
        fbq('trackCustom', 'PaymentMethodSelected', {
          payment_method: this.value,
          value: originalTotal,
          currency: 'INR'
        });
      }
      
      if (typeof gtag !== 'undefined') {
        gtag('event', 'select_payment_method', {
          currency: 'INR',
          value: originalTotal,
          payment_type: this.value
        });
      }
      
      if (this.value === 'cod') {
        // Show COD advance payment info and logistics charges
        codAdvanceInfo.classList.remove('hidden');
        shippingChargesInfo.classList.remove('hidden');
        totalAmount.textContent = '₹100.00';
        codRemaining.textContent = '₹' + (originalTotal - 100).toFixed(2);
      } else {
        // Hide COD advance payment info and logistics charges, show full total
        codAdvanceInfo.classList.add('hidden');
        shippingChargesInfo.classList.add('hidden');
        totalAmount.textContent = '₹' + originalTotal.toFixed(2);
      }
    });
  });
  
  // Add visual feedback for form submission and track checkout attempt
  form.addEventListener('submit', function(e) {
    const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
    const paymentValue = selectedPaymentMethod === 'cod' ? 100 : originalTotal;
    
    // Track checkout completion attempt
    if (typeof fbq !== 'undefined') {
      fbq('track', 'AddPaymentInfo', {
        content_name: 'Checkout Submission',
        content_category: 'ecommerce',
        value: paymentValue,
        currency: 'INR',
        payment_method: selectedPaymentMethod
      });
      
      // Also track custom checkout event
      fbq('trackCustom', 'checkout', {
        payment_method: selectedPaymentMethod,
        value: paymentValue,
        currency: 'INR',
        num_items: {{ cart_items|length }},
        content_type: 'checkout_form_submit'
      });
    }
    
    if (typeof gtag !== 'undefined') {
      gtag('event', 'add_payment_info', {
        currency: 'INR',
        value: paymentValue,
        payment_type: selectedPaymentMethod
      });
      
      // Custom checkout event for GA4
      gtag('event', 'checkout_submit', {
        currency: 'INR',
        value: paymentValue,
        payment_method: selectedPaymentMethod,
        event_category: 'ecommerce',
        event_label: 'checkout_form_submission'
      });
    }
    
    // Add visual feedback
    submitBtn.innerHTML = '<svg class="animate-spin w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Processing Order...';
    submitBtn.disabled = true;
  });

  // Enhanced form field interactions with engagement tracking
  const formInputs = form.querySelectorAll('input, select, textarea');
  let fieldInteractions = 0;
  
  formInputs.forEach(input => {
    input.addEventListener('focus', function() {
      this.closest('.form-group').classList.add('focused');
      
      // Track first field interaction
      if (fieldInteractions === 0) {
        if (typeof fbq !== 'undefined') {
          fbq('trackCustom', 'CheckoutFormEngagement', {
            event_type: 'first_field_focus',
            field_name: this.name || this.type,
            value: originalTotal,
            currency: 'INR'
          });
        }
      }
      fieldInteractions++;
    });
    
    input.addEventListener('blur', function() {
      this.closest('.form-group').classList.remove('focused');
      
      // Real-time validation feedback
      if (this.value && this.checkValidity()) {
        this.classList.add('valid');
        this.classList.remove('invalid');
      } else if (this.value) {
        this.classList.add('invalid');
        this.classList.remove('valid');
      }
    });
  });

  // Track checkout page engagement time
  let startTime = Date.now();
  let engagementTracked = false;
  
  // Track after 30 seconds of engagement
  setTimeout(() => {
    if (!engagementTracked) {
      engagementTracked = true;
      if (typeof fbq !== 'undefined') {
        fbq('trackCustom', 'CheckoutPageEngagement', {
          time_spent: '30_seconds_plus',
          value: originalTotal,
          currency: 'INR'
        });
      }
    }
  }, 30000);

  // Track page visibility changes
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden') {
      const timeSpent = Math.round((Date.now() - startTime) / 1000);
      if (timeSpent > 10 && typeof fbq !== 'undefined') {
        fbq('trackCustom', 'CheckoutPageTimeSpent', {
          time_spent_seconds: timeSpent,
          field_interactions: fieldInteractions,
          value: originalTotal,
          currency: 'INR'
        });
      }
    }
  });
});
</script>

<!-- Additional Styles for Form States -->
<style>
.form-group.focused {
  transform: translateY(-2px);
  transition: transform 0.2s ease;
}

.form-group input.valid,
.form-group select.valid,
.form-group textarea.valid {
  @apply border-green-400 bg-green-50;
}

.form-group input.invalid,
.form-group select.invalid,
.form-group textarea.invalid {
  @apply border-red-400 bg-red-50;
}
</style>
{% endblock %}
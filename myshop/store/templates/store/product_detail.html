{% extends 'store/base.html' %}
{% block title %}{% if product.meta_title %}{{ product.meta_title }}{% else %}{{ product.name }} - Premium {{ product.category.name }} - {{ SITE_NAME }}{% endif %}{% endblock %}
{% block meta_description %}{% if product.meta_description %}{{ product.meta_description }}{% else %}{{ product.short_description|default:product.description|truncatewords:25 }} - Premium quality guaranteed.{% endif %}{% endblock %}
{% block meta_keywords %}{% if product.meta_keywords %}{{ product.meta_keywords }}{% else %}{{ product.name }}, premium {{ product.category.name|lower }}, luxury cigar accessories, {{ SITE_NAME }}{% endif %}{% endblock %}

{% block content %}
<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "name": "Home",
    "item": "{{ request.scheme }}://{{ request.get_host }}"
  },{
    "@type": "ListItem",
    "position": 2,
    "name": "{{ product.category.name|escapejs }}",
    "item": "{{ request.scheme }}://{{ request.get_host }}/products/?category={{ product.category.slug }}"
  },{
    "@type": "ListItem",
    "position": 3,
    "name": "{{ product.name|escapejs }}"
  }]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Product",
  "name": "{{ product.name|escapejs }}",
  "image": [
    "{{ product.image.url }}"{% for img in product.images.all %},
    "{{ img.image.url }}"{% endfor %}
  ],
  "description": "{{ product.short_description|default:product.description|truncatewords:50|escapejs }}",
  "sku": "{{ product.id }}",
  "offers": {
    "@type": "Offer",
    "url": "{{ request.build_absolute_uri }}",
    "priceCurrency": "INR",
    "price": "{{ product.price }}",
    "priceValidUntil": "2025-12-31T23:59:59+05:30",
    "itemCondition": "https://schema.org/NewCondition",
    "availability": "https://schema.org/{% if product.stock > 0 %}InStock{% else %}OutOfStock{% endif %}",
    "hasMerchantReturnPolicy": {
      "@type": "MerchantReturnPolicy",
      "applicableCountry": "IN",
      "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow",
      "merchantReturnDays": 7,
      "returnMethod": "https://schema.org/ReturnByMail",
      "returnFees": "https://schema.org/FreeReturn"
    },
    "shippingDetails": {
      "@type": "OfferShippingDetails",
      "shippingRate": {
        "@type": "MonetaryAmount",
        "value": "0",
        "currency": "INR"
      },
      "shippingDestination": {
        "@type": "DefinedRegion",
        "addressCountry": "IN"
      },
      "deliveryTime": {
        "@type": "ShippingDeliveryTime",
        "handlingTime": {
          "@type": "QuantitativeValue",
          "minValue": 1,
          "maxValue": 2,
          "unitCode": "DAY"
        },
        "transitTime": {
          "@type": "QuantitativeValue",
          "minValue": 3,
          "maxValue": 7,
          "unitCode": "DAY"
        }
      }
    }
  }{% if product.get_review_count > 0 %},
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ product.get_average_rating }}",
    "reviewCount": "{{ product.get_review_count }}",
    "bestRating": "5",
    "worstRating": "1"
  },
  "review": [
    {% for review in reviews %}
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "{{ review.user.get_full_name|default:review.user.username|escapejs }}"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "{{ review.rating }}",
        "bestRating": "5",
        "worstRating": "1"
      },
      "name": "{% if review.title and review.title|length > 0 %}{{ review.title|escapejs }}{% else %}Customer Review{% endif %}",
      "reviewBody": "{{ review.review|truncatewords:30|escapejs }}",
      "datePublished": "{{ review.created_at|date:'Y-m-d' }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
  {% endif %}
}
</script>

<!-- Premium Product Detail Page -->
<div class="bg-gray-50 min-h-screen py-8">
  <div class="max-w-7xl mx-auto px-4">
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <ol class="flex items-center space-x-2 text-sm">
        <li><a href="{% url 'home' %}" class="text-gray-600 hover:text-yellow-600 transition-colors">Home</a></li>
        <li class="text-gray-400">/</li>
        <li><a href="/products/?category={{ product.category.slug }}" class="text-gray-600 hover:text-yellow-600 transition-colors">{{ product.category.name }}</a></li>
        <li class="text-gray-400">/</li>
        <li class="text-gray-900 font-medium">{{ product.name }}</li>
      </ol>
    </nav>

    <!-- Main Product Section -->
    <div class="grid lg:grid-cols-2 gap-6 md:gap-12 bg-white rounded-2xl shadow-xl overflow-hidden p-4 md:p-8">
      
      <!-- Left: Image Gallery -->
      <div class="space-y-6">
        <!-- Main Image -->
        <div class="relative aspect-square bg-gray-50 rounded-2xl overflow-hidden group">
          <img id="mainImage"
               src="{% if product.images.first %}{{ product.images.first.image.url }}{% else %}{{ product.image.url }}{% endif %}"
               class="w-full h-full object-contain p-8 transition-transform duration-500 group-hover:scale-110"
               alt="{{ product.name }}">
          
          <!-- Image Zoom Indicator -->
          <div class="absolute top-4 right-4 bg-black/20 text-white px-3 py-1 rounded-full text-sm opacity-0 group-hover:opacity-100 transition-opacity">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
            </svg>
            Hover to zoom
          </div>
        </div>

        <!-- Thumbnails -->
        {% if product.images.all %}
        <div class="flex gap-3 flex-wrap justify-center">
          {% for img in product.images.all %}
            <button onclick="document.getElementById('mainImage').src = '{{ img.image.url }}'" 
                    class="w-20 h-20 rounded-lg border-2 border-gray-200 hover:border-yellow-400 transition-colors overflow-hidden group">
              <img src="{{ img.image.url }}"
                   class="w-full h-full object-contain p-2 group-hover:scale-110 transition-transform"
                   alt="Product thumbnail">
            </button>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- Right: Product Info -->
      <div class="space-y-4 md:space-y-6">
        <!-- Product Header -->
        <div>
          <!-- Category Badge -->
          <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 mb-4">
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
            </svg>
            {{ product.category.name }}
          </div>
          
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-3">{{ product.name }}</h1>
          {% if product.short_description %}
            <p class="text-lg text-gray-600 leading-relaxed">{{ product.short_description }}</p>
          {% endif %}
        </div>

        <!-- Rating & Reviews -->
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-1">
            {% for i in "12345" %}
              {% if forloop.counter <= product.get_average_rating %}
                <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
              {% else %}
                <svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
              {% endif %}
            {% endfor %}
          </div>
          <span class="text-sm text-gray-600">({{ product.get_average_rating }}) â€¢ {{ product.get_review_count }} review{{ product.get_review_count|pluralize }}</span>
        </div>

        <!-- Price Section -->
        <div class="bg-gray-50 rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <span class="text-2xl md:text-3xl font-bold text-gray-900">â‚¹{{ product.price }}</span>
            <div class="text-right">
              <span class="text-sm text-green-600 font-medium">âœ“ In Stock</span>
              <div class="text-xs text-gray-500">Free shipping available</div>
            </div>
          </div>
          
          <!-- Features -->
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="flex items-center text-gray-600">
              <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Premium Quality
            </div>
            <div class="flex items-center text-gray-600">
              <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Fast Delivery
            </div>
            <div class="flex items-center text-gray-600">
              <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
              </svg>
              Secure Payment
            </div>
            <div class="flex items-center text-gray-600">
              <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
              Expert Support
            </div>
          </div>
        </div>

        <!-- Purchase Form -->
        <form id="add-to-cart-form" method="post" action="{% url 'add_to_cart' product.id %}?next={{ request.path }}" class="space-y-6">
          {% csrf_token %}

          <!-- Quantity Selector -->
          <div>
            <label for="qtyInput" class="block text-sm font-semibold text-gray-700 mb-2">Quantity</label>
            <div class="flex items-center bg-gray-50 rounded-xl overflow-hidden w-fit max-w-full">
              <button type="button" onclick="changeQty(-1)"
                      class="px-3 md:px-4 py-2 md:py-3 text-base md:text-lg font-bold text-gray-700 hover:bg-gray-200 transition-colors">âˆ’</button>
              <input id="qtyInput" name="quantity" value="1" min="1" readonly
                    class="w-12 md:w-16 text-center py-2 md:py-3 focus:outline-none bg-transparent font-semibold text-sm md:text-base">
              <button type="button" onclick="changeQty(1)"
                      class="px-3 md:px-4 py-2 md:py-3 text-base md:text-lg font-bold text-gray-700 hover:bg-gray-200 transition-colors">+</button>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="space-y-3 md:space-y-4">
            <button type="submit" name="action" value="buy"
                    class="w-full bg-gradient-to-r from-yellow-400 to-amber-500 text-black py-3 md:py-4 px-6 md:px-8 rounded-xl font-bold text-base md:text-lg hover:from-yellow-500 hover:to-amber-600 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
              ðŸ”¥ Buy Now - â‚¹{{ product.price }}
            </button>
            
            <button type="submit" name="action" value="add"
                    class="w-full bg-gray-900 text-white py-3 md:py-4 px-6 md:px-8 rounded-xl font-semibold text-base md:text-lg hover:bg-gray-800 transition-all duration-300 border-2 border-transparent hover:border-yellow-400">
              ðŸ›’ Add to Cart
            </button>
            
            <a href="{% url 'bulk_order' product.slug %}" 
               class="w-full bg-purple-100 text-purple-800 py-2 md:py-3 px-6 md:px-8 rounded-xl font-semibold text-center hover:bg-purple-200 transition-all duration-300 flex items-center justify-center text-sm md:text-base">
              <svg class="w-4 md:w-5 h-4 md:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
              Bulk Order Inquiry
            </a>
          </div>
        </form>

        <!-- Trust Badges -->
        <div class="border-t pt-6">
          <div class="grid grid-cols-3 gap-4 text-center">
            <div class="text-xs text-gray-600">
              <div class="w-8 h-8 mx-auto mb-1 bg-green-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
              </div>
              Secure Checkout
            </div>
            <div class="text-xs text-gray-600">
              <div class="w-8 h-8 mx-auto mb-1 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                </svg>
              </div>
              Easy Returns
            </div>
            <div class="text-xs text-gray-600">
              <div class="w-8 h-8 mx-auto mb-1 bg-yellow-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
              </div>
              Fast Shipping
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Description -->
    {% if product.description %}
    <div class="bg-white mt-12 rounded-2xl shadow-xl p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        Product Details
      </h2>
      <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
        {{ product.description|safe }}
      </div>
    </div>
    {% endif %}

    <!-- Reviews Section -->
    <div class="bg-white mt-12 rounded-2xl shadow-xl p-8">
      {% include 'store/partials/product_reviews.html' %}
    </div>

    <!-- Related Products Section -->
    {% if related_products %}
    <div class="mt-12">
      <h2 class="text-2xl font-bold text-gray-900 mb-8 text-center">You Might Also Like</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        {% for related_product in related_products %}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 group">
          <!-- Product Image -->
          <div class="aspect-square bg-gray-50 overflow-hidden">
            <a href="{{ related_product.get_absolute_url }}">
              <img src="{% if related_product.images.first %}{{ related_product.images.first.image.url }}{% else %}{{ related_product.image.url }}{% endif %}" 
                   alt="{{ related_product.name }}"
                   class="w-full h-full object-contain p-4 group-hover:scale-110 transition-transform duration-300">
            </a>
          </div>
          
          <!-- Product Info -->
          <div class="p-4">
            <div class="mb-2">
              <span class="inline-block px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">
                {{ related_product.category.name }}
              </span>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2 group-hover:text-yellow-600 transition-colors">
              <a href="{{ related_product.get_absolute_url }}">{{ related_product.name }}</a>
            </h3>
            {% if related_product.short_description %}
            <p class="text-sm text-gray-600 mb-3 line-clamp-2">{{ related_product.short_description }}</p>
            {% endif %}
            <div class="flex items-center justify-between">
              <span class="text-xl font-bold text-gray-900">â‚¹{{ related_product.price }}</span>
              <form method="post" action="{% url 'add_to_cart' related_product.id %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button type="submit" name="action" value="add"
                        class="bg-yellow-400 hover:bg-yellow-500 text-black px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-300 transform hover:scale-105">
                  Add to Cart
                </button>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- View All Products Button -->
      <div class="text-center">
        <a href="/products/?category={{ product.category.slug }}" 
           class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-yellow-400 to-amber-500 text-black font-semibold rounded-lg hover:from-yellow-500 hover:to-amber-600 transition-all duration-300">
          View All {{ product.category.name }} Products
          <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
          </svg>
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Quantity change function
  window.changeQty = function(delta) {
    const input = document.getElementById('qtyInput');
    let current = parseInt(input.value) || 1;
    current = current + delta;
    if (current < 1) current = 1;
    if (current > 99) current = 99; // Maximum quantity
    input.value = current;
  };

  // Image gallery keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
      const thumbnails = document.querySelectorAll('button[onclick*="mainImage"]');
      if (thumbnails.length > 1) {
        const currentSrc = document.getElementById('mainImage').src;
        let currentIndex = 0;
        
        // Find current image index
        thumbnails.forEach((thumb, index) => {
          if (thumb.querySelector('img').src === currentSrc) {
            currentIndex = index;
          }
        });
        
        // Navigate to next/previous image
        if (e.key === 'ArrowLeft') {
          currentIndex = currentIndex > 0 ? currentIndex - 1 : thumbnails.length - 1;
        } else {
          currentIndex = currentIndex < thumbnails.length - 1 ? currentIndex + 1 : 0;
        }
        
        thumbnails[currentIndex].click();
      }
    }
  });

  // Add to cart with animation feedback
  const cartForm = document.getElementById('add-to-cart-form');
  if (cartForm) {
    cartForm.addEventListener('submit', function(e) {
      const submitButton = e.submitter;
      if (submitButton && submitButton.name === 'action' && submitButton.value === 'add') {
        submitButton.innerHTML = '<svg class="animate-spin w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Adding...';
        submitButton.disabled = true;
      }
    });
  }
});
</script>

<!-- Additional Styles for Better UX -->
<style>
.prose {
  line-height: 1.7;
}
.prose p {
  margin-bottom: 1rem;
}
.prose h1, .prose h2, .prose h3 {
  color: #374151;
  font-weight: 600;
  margin-top: 2rem;
  margin-bottom: 1rem;
}
.prose ul, .prose ol {
  margin: 1rem 0;
  padding-left: 1.5rem;
}
.prose li {
  margin: 0.5rem 0;
}
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
{% endblock %}

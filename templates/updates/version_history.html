{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Version History{% endblock %}

{% block extrahead %}
<style>
    .version-container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
    }

    .version-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        text-align: center;
    }

    .current-version {
        background: rgba(255,255,255,0.2);
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
        display: inline-block;
    }

    .actions-bar {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .version-timeline {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }

    .version-item {
        padding: 25px;
        border-bottom: 1px solid #eee;
        position: relative;
    }

    .version-item:last-child {
        border-bottom: none;
    }

    .version-item.current {
        background: #f8fff8;
        border-left: 4px solid #28a745;
    }

    .version-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: #667eea;
        opacity: 0.3;
    }

    .version-item.current::before {
        background: #28a745;
        opacity: 1;
    }

    .version-header-info {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .version-info {
        flex-grow: 1;
    }

    .version-number {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }

    .version-date {
        color: #666;
        font-size: 0.9em;
    }

    .version-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }

    .badge-current {
        background: #d4edda;
        color: #155724;
    }

    .badge-backup {
        background: #e2e3e5;
        color: #495057;
    }

    .version-details {
        margin-bottom: 15px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .detail-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .detail-label {
        font-weight: bold;
        color: #495057;
        font-size: 0.9em;
        margin-bottom: 4px;
    }

    .detail-value {
        color: #333;
    }

    .version-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid #667eea;
        color: #667eea;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    .file-size {
        color: #666;
        font-size: 0.9em;
    }

    @media (max-width: 768px) {
        .version-header-info {
            flex-direction: column;
            align-items: stretch;
        }

        .version-actions {
            justify-content: stretch;
        }

        .version-actions .btn {
            flex: 1;
            text-align: center;
        }

        .detail-grid {
            grid-template-columns: 1fr;
        }

        .actions-bar {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="version-container">
    <div class="version-header">
        <h1>üìä Version History & Backups</h1>
        <p>Track your CMS version history and manage system backups</p>

        <div class="current-version">
            <strong>Current Version: {{ current_version }}</strong>
        </div>
    </div>

    <div class="actions-bar">
        <div>
            <a href="{% url 'updates:dashboard' %}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
        <div>
            <button class="btn btn-primary" onclick="refreshVersionHistory()">üîÑ Refresh</button>
        </div>
    </div>

    <div class="version-timeline">
        {% if version_history %}
            <!-- Current Version Entry -->
            <div class="version-item current">
                <div class="version-header-info">
                    <div class="version-info">
                        <div class="version-number">{{ current_version }}</div>
                        <div class="version-date">Current Active Version</div>
                    </div>
                    <span class="version-badge badge-current">Current</span>
                </div>

                <div class="version-details">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">‚úÖ Active</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Installation</div>
                            <div class="detail-value">Running</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Backup Available</div>
                            <div class="detail-value">
                                {% if version_history %}‚úÖ Yes{% else %}‚ùå No{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Versions from Backups -->
            {% for backup in version_history %}
            <div class="version-item">
                <div class="version-header-info">
                    <div class="version-info">
                        <div class="version-number">{{ backup.version }}</div>
                        <div class="version-date">üìÖ {{ backup.date|date:"M d, Y H:i" }}</div>
                    </div>
                    <span class="version-badge badge-backup">Backup</span>
                </div>

                <div class="version-details">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Backup Size</div>
                            <div class="detail-value file-size">
                                {{ backup.size|filesizeformat }}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Backup Date</div>
                            <div class="detail-value">{{ backup.date|date:"M d, Y H:i" }}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">File Path</div>
                            <div class="detail-value" style="font-family: monospace; font-size: 0.8em; word-break: break-all;">
                                {{ backup.file_path }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="version-actions">
                    <button class="btn btn-sm btn-outline"
                            onclick="showBackupInfo('{{ backup.version }}', '{{ backup.file_path }}', '{{ backup.size|filesizeformat }}', '{{ backup.date|date:"M d, Y H:i" }}')">
                        ‚ÑπÔ∏è View Details
                    </button>

                    {% if backup.version != current_version %}
                    <button class="btn btn-sm btn-danger"
                            onclick="confirmRollback('{{ backup.version }}', '{{ backup.file_path }}')">
                        ‚Ü©Ô∏è Rollback
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-secondary" disabled>
                        Current Version
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

        {% else %}
            <div class="empty-state">
                <div style="font-size: 48px; margin-bottom: 20px;">üìÇ</div>
                <h3>No version history available</h3>
                <p>Version history will appear here as you perform updates and create backups.</p>
                <div style="margin-top: 20px;">
                    <a href="{% url 'updates:dashboard' %}" class="btn btn-primary">‚Üê Back to Dashboard</a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Backup Info Modal -->
<div id="backup-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; min-width: 500px; max-width: 90vw;">
        <h3 id="backup-modal-title">Backup Information</h3>
        <div id="backup-modal-content"></div>
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="closeBackupModal()" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Rollback Confirmation Modal -->
<div id="rollback-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; min-width: 500px; max-width: 90vw;">
        <h3 style="color: #dc3545;">‚ö†Ô∏è Confirm Rollback</h3>
        <div id="rollback-modal-content"></div>
        <div style="text-align: right; margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeRollbackModal()" class="btn btn-secondary">Cancel</button>
            <button id="confirm-rollback-btn" onclick="performRollback()" class="btn btn-danger">Rollback</button>
        </div>
    </div>
</div>

<script>
let selectedBackupPath = '';

function refreshVersionHistory() {
    window.location.reload();
}

function showBackupInfo(version, filePath, size, date) {
    document.getElementById('backup-modal-title').textContent = `Backup: Version ${version}`;
    document.getElementById('backup-modal-content').innerHTML = `
        <div style="margin: 20px 0;">
            <div style="display: grid; gap: 15px;">
                <div style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <strong>Version:</strong> ${version}
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <strong>Created:</strong> ${date}
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <strong>Size:</strong> ${size}
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; word-break: break-all;">
                    <strong>File Path:</strong><br>
                    <code style="font-size: 0.9em;">${filePath}</code>
                </div>
            </div>
        </div>
    `;
    document.getElementById('backup-modal').style.display = 'block';
}

function closeBackupModal() {
    document.getElementById('backup-modal').style.display = 'none';
}

function confirmRollback(version, backupPath) {
    selectedBackupPath = backupPath;
    document.getElementById('rollback-modal-content').innerHTML = `
        <div style="margin: 20px 0;">
            <p style="margin-bottom: 15px;">
                <strong>You are about to rollback to version ${version}.</strong>
            </p>
            <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; margin-bottom: 15px;">
                ‚ö†Ô∏è <strong>Warning:</strong> This action will replace your current CMS installation with the backup version.
            </div>
            <ul style="margin: 15px 0; padding-left: 20px; color: #666;">
                <li>Current data and files will be overwritten</li>
                <li>Recent changes since the backup may be lost</li>
                <li>Database will be restored to backup state</li>
                <li>This action cannot be easily undone</li>
            </ul>
            <p style="margin-top: 15px; font-weight: bold;">
                Are you sure you want to proceed with the rollback?
            </p>
        </div>
    `;
    document.getElementById('rollback-modal').style.display = 'block';
}

function closeRollbackModal() {
    document.getElementById('rollback-modal').style.display = 'none';
    selectedBackupPath = '';
}

function performRollback() {
    if (!selectedBackupPath) {
        alert('No backup selected');
        return;
    }

    const confirmBtn = document.getElementById('confirm-rollback-btn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Rolling back...';

    fetch('{% url "updates:rollback_update" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            backup_path: selectedBackupPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Rollback completed successfully! Please restart your server.');
            window.location.reload();
        } else {
            alert('Rollback failed: ' + data.error);
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Rollback';
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Rollback';
    })
    .finally(() => {
        closeRollbackModal();
    });
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
    const backupModal = document.getElementById('backup-modal');
    const rollbackModal = document.getElementById('rollback-modal');

    if (event.target === backupModal) {
        closeBackupModal();
    }
    if (event.target === rollbackModal) {
        closeRollbackModal();
    }
});
</script>
{% endblock %}